version: 2.0

jobs:
  buildsnpeff:
    machine: true
    steps:
      - checkout
      - run: docker build -t nfcore/sareksnpeff:dev.${GENOME} containers/snpeff/. --build-arg GENOME=${GENOME} --build-arg SNPEFF_CACHE_VERSION=${SNPEFF_CACHE_VERSION}
      - run: echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin ; docker push nfcore/sareksnpeff:dev.${GENOME}

  deploy:
    machine: true
    steps:
      - checkout
      - run:
          name: Build Docker Image
          command: docker build -t nfcore/sarekvep:dev.${GENOME} containers/vep/. --build-arg GENOME=${GENOME} --build-arg SPECIES=${SPECIES} --build-arg VEP_VERSION=${VEP_VERSION}
      - run:
          name: Push Docker Image to DockerHub
          no_output_timeout: 2h
          command: echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin ; docker push nfcore/sarekvep:dev.${GENOME}

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - buildsnpeff
          environment:
            GENOME: GRCh37
            SNPEFF_CACHE_VERSION: 75
      - buildsnpeff
          environment:
            GENOME: GRCh38
            SNPEFF_CACHE_VERSION: 86
      - buildsnpeff
          environment:
            GENOME: GRCm38
            SNPEFF_CACHE_VERSION: 86
      - deploy
          environment:
            GENOME: GRCh37
            SPECIES: homo_sapiens
            VEP_VERSION: 95
      - deploy
          environment:
            GENOME: GRCh38
            SPECIES: homo_sapiens
            VEP_VERSION: 95
      - deploy
          environment:
            GENOME: GRCm38
            SPECIES: mus_musculus
            VEP_VERSION: 95
